#!/bin/bash

echo

CONFIG="config.mk"
# PREFIX="/usr/local"
# VERSION=$(grep "define PNGQUANT_VERSION" pngquant.c | grep -Eo "[12]\.[0-9.]*")

HELP=
DEBUG=
SSE=
OPENMP=
LCMS2=
CFLAGS=
LDFLAGS=
EXTRA_CFLAGS=
EXTRA_LDFLAGS=
LIBPNG_DIR=

for i in "$@"; do
    case $i in
    -h|--help)
        HELP=1
        break
        ;;
    # overrides environment variable
    CC=*)
        CC=${i#*=}
        ;;
    # installation directory
    # --prefix=*)
    #     PREFIX=${i#*=}
    #     ;;
    --enable-debug)
        DEBUG=1
        ;;
    --enable-sse)
        SSE=1
        ;;
    --disable-sse)
        SSE=0
        ;;
    --with-openmp)
        OPENMP=1
        ;;
    --with-lcms2)
        LCMS2=1
        ;;
    # append to CFLAGS
    --extra-cflags=*)
        EXTRA_CFLAGS=${i#*=}
        ;;
    # append to LDFLAGS
    --extra-ldflags=*)
        EXTRA_LDFLAGS=${i#*=}
        ;;
    --libpng-dir=*)
        LIBPNG_DIR=${i#*=}
        ;;
    esac
done

cflags() {
    CFLAGS="$CFLAGS $1"
}

lflags() {
    LDFLAGS="$LDFLAGS $1"
}

status() {
    printf "%20s: %s\n" "$1" "$2"
}

error() {
    status "$1" "ERROR"
    echo
    exit 1
}

# append to CFLAGS if compiler supports switch
compiler_supports() {
    if [ -z "$(echo | $CC $1 -E -o /dev/null - 2>&1)" ]; then
        cflags "$1"
    fi
}

# help
if [ -n "$HELP" ]; then
    echo
    exit 0
fi

# make gcc default compiler unless CC is already set
if [ -z "$CC" ]; then
    CC=gcc
fi
status "compiler" "$CC"

# init flags
cflags "-std=c99 -O3 -funroll-loops -fomit-frame-pointer"
cflags "-Wall -Wno-unknown-pragmas -I."
lflags "-lm lib/libimagequant.a"

# debug
if [ -z "$DEBUG" ]; then
    cflags "-DNDEBUG"
    status "debug" "no"
else
    status "debug" "yes"
fi

# sse
if [ -n "$SSE" ]; then
    cflags "-DUSE_SSE=$SSE"
    if [ "$SSE" == 1 ]; then
        # must be set explicitly for GCC on x86_32
        compiler_supports "-msse -mfpmath=sse"
        status "SSE" "yes"
    else
        status "SSE" "no"
    fi
else
    status "SSE" "auto"
fi

# openmp
if [ -n "$OPENMP" ]; then
    cflags "-fopenmp"
    lflags "-fopenmp"
    status "OpenMP" "yes"
else
    # ICC only: disables omp pragma warnings when -fopenmp is not set
    compiler_supports "-wd3180"
    status "OpenMP" "no"
fi

# libpng
if [ -n "$LIBPNG_DIR" ]; then
    PNG_STATIC=$(find $LIBPNG_DIR -type f -name libpng\*.a 2>/dev/null)
    if [ -n "$PNG_STATIC" ]; then
        cflags "-I$LIBPNG_DIR"
        lflags "$PNG_STATIC"
        status "libpng" "$LIBPNG_DIR"
    else
        error "libpng"
    fi
else
    if [ "$(pkg-config --exists libpng; echo $?)" == 0 ]; then
        cflags "$(pkg-config --cflags libpng)"
        lflags "$(pkg-config --libs libpng)"
        status "libpng" "$(pkg-config --modversion libpng)"
    else
        error "libpng"
    fi
fi

# zlib
if [ "$(pkg-config --exists zlib; echo $?)" == 0 ]; then
    cflags "$(pkg-config --cflags zlib)"
    lflags "-lm $(pkg-config --libs zlib)"
    status "zlib" "$(pkg-config --modversion zlib)"
else
        error "zlib"
fi

# lcms2
if [ -n "$LCMS2" ]; then
    if [ "$(pkg-config --exists lcms2; echo $?)" == 0 ]; then
        cflags "$(pkg-config --cflags lcms2)"
        lflags "$(pkg-config --libs lcms2)"
        status "lcms2" "$(pkg-config --modversion lcms2)"
    else
        error "lcms2"
    fi
else
    status "lcms2" "no"
fi

if [ -n "$EXTRA_CFLAGS" ]; then
    cflags "$EXTRA_CFLAGS"
fi

if [ -n "$EXTRA_LDFLAGS" ]; then
    lflags "$EXTRA_LDFLAGS"
fi

# as of GCC 4.5 floating point math is slow in C99, unless this is set
compiler_supports "-fexcess-precision=fast"

# ICC
compiler_supports "-xHOST -fp-model source"

# write file
echo "# auto-generated by configure" > $CONFIG
echo >> $CONFIG
echo "CC=$CC" >> $CONFIG
echo "CFLAGS=$CFLAGS" >> $CONFIG
echo "LDFLAGS=$LDFLAGS" >> $CONFIG

echo
